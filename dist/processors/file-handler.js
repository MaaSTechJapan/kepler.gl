"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.readFile = readFile;
exports.getFileHandler = getFileHandler;
exports.getFileType = getFileType;
exports.loadCsv = loadCsv;
exports.loadJSON = loadJSON;
exports.readJSONFile = readJSONFile;
exports.isGeoJson = isGeoJson;
exports.isFeature = isFeature;
exports.isFeatureCollection = isFeatureCollection;
exports.isRowObject = isRowObject;
exports.isKeplerGlMap = isKeplerGlMap;
exports.determineJsonProcess = determineJsonProcess;

var _toConsumableArray2 = _interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));

var _window = require("global/window");

var _console = _interopRequireDefault(require("global/console"));

var _dataProcessor = require("./data-processor");

var _utils = require("../utils/utils");

var _defaultSettings = require("../constants/default-settings");

// Copyright (c) 2020 Uber Technologies, Inc.
//
// Permission is hereby granted, free of charge, to any person obtaining a copy
// of this software and associated documentation files (the "Software"), to deal
// in the Software without restriction, including without limitation the rights
// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
// copies of the Software, and to permit persons to whom the Software is
// furnished to do so, subject to the following conditions:
//
// The above copyright notice and this permission notice shall be included in
// all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
// THE SOFTWARE.
var FILE_HANDLERS = {
  csv: loadCsv,
  json: loadJSON
};

function readFile(_ref) {
  var file = _ref.file,
      _ref$fileCache = _ref.fileCache,
      fileCache = _ref$fileCache === void 0 ? [] : _ref$fileCache;
  return new Promise(function (resolve, reject) {
    var _getFileHandler = getFileHandler(file),
        handler = _getFileHandler.handler,
        format = _getFileHandler.format;
    /*    if (!handler) {
          Console.warn(
            `Canont determine file handler for file ${file.name}. It must have a valid file extension`
          );
          resolve(fileCache);
        }
    */


    handler({
      file: file,
      format: format
    }).then(function (result) {
      if (!result || !result.data) {
        // return fileCache, to keep process other files
        resolve(fileCache);
      }

      resolve([].concat((0, _toConsumableArray2["default"])(fileCache), [{
        data: result.data,
        info: {
          label: file.name,
          format: result.format
        }
      }]));
    });
  });
}

function getFileHandler(fileBlob) {
  var type = getFileType(fileBlob.name);
  return {
    handler: FILE_HANDLERS[type],
    format: type
  };
}

function getFileType(filename) {
  if (filename.endsWith('csv')) {
    return 'csv';
  } else if (filename.endsWith('json') || filename.endsWith('geojson')) {
    // Read GeoJson from browser
    return 'json';
  } else {
    return 'json';
  } // Wait to add other file type handler


  return 'other';
}

function readCSVFile(fileBlob) {
  return new Promise(function (resolve, reject) {
    var fileReader = new _window.FileReader();

    fileReader.onload = function (_ref2) {
      var result = _ref2.target.result;
      resolve(result);
    };

    fileReader.readAsText(fileBlob);
  });
}

function loadCsv(_ref3) {
  var file = _ref3.file,
      format = _ref3.format,
      _ref3$processor = _ref3.processor,
      processor = _ref3$processor === void 0 ? _dataProcessor.processCsvData : _ref3$processor;
  return readCSVFile(file).then(function (rawData) {
    return rawData ? {
      data: processor(rawData),
      format: format
    } : null;
  });
}

function loadJSON(_ref4) {
  var file = _ref4.file,
      _ref4$processor = _ref4.processor,
      processor = _ref4$processor === void 0 ? _dataProcessor.processGeojson : _ref4$processor;
  return readJSONFile(file).then(function (content) {
    if (isKeplerGlMap(content)) {
      return {
        format: _defaultSettings.DATASET_FORMATS.keplergl,
        data: (0, _dataProcessor.processKeplerglJSON)(content)
      };
    } else if (isRowObject(content)) {
      return {
        format: _defaultSettings.DATASET_FORMATS.row,
        data: (0, _dataProcessor.processRowObject)(content)
      };
    } else if (isGeoJson(content)) {
      return {
        format: _defaultSettings.DATASET_FORMATS.geojson,
        data: (0, _dataProcessor.processGeojson)(content)
      };
    } // unsupported json format


    _console["default"].warn("unsupported Json format ".concat(file.name));

    return null;
  });
}

function readJSONFile(fileBlob) {
  return new Promise(function (resolve, reject) {
    var fileReader = new _window.FileReader();

    fileReader.onload = function (_ref5) {
      var result = _ref5.target.result;

      try {
        var json = JSON.parse(result);
        resolve(json);
      } catch (err) {
        reject(null);
      }
    };

    fileReader.readAsText(fileBlob, 'UTF-8');
  });
}

function isGeoJson(json) {
  // json can be feature collection
  // or simgle feature
  return (0, _utils.isPlainObject)(json) && (isFeature(json) || isFeatureCollection(json));
}

function isFeature(json) {
  return json.type === 'Feature' && json.geometry;
}

function isFeatureCollection(json) {
  return json.type === 'FeatureCollection' && json.features;
}

function isRowObject(json) {
  return Array.isArray(json) && (0, _utils.isPlainObject)(json[0]);
}

function isKeplerGlMap(json) {
  return (0, _utils.isPlainObject)(json) && json.datasets && json.config && json.info && json.info.app === 'kepler.gl';
}

function determineJsonProcess(_ref6, defaultProcessor) {
  var dataset = _ref6.dataset,
      format = _ref6.format;

  if (isKeplerGlMap(dataset)) {
    return _dataProcessor.processKeplerglJSON;
  }

  return defaultProcessor;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9wcm9jZXNzb3JzL2ZpbGUtaGFuZGxlci5qcyJdLCJuYW1lcyI6WyJGSUxFX0hBTkRMRVJTIiwiY3N2IiwibG9hZENzdiIsImpzb24iLCJsb2FkSlNPTiIsInJlYWRGaWxlIiwiZmlsZSIsImZpbGVDYWNoZSIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0IiwiZ2V0RmlsZUhhbmRsZXIiLCJoYW5kbGVyIiwiZm9ybWF0IiwidGhlbiIsInJlc3VsdCIsImRhdGEiLCJpbmZvIiwibGFiZWwiLCJuYW1lIiwiZmlsZUJsb2IiLCJ0eXBlIiwiZ2V0RmlsZVR5cGUiLCJmaWxlbmFtZSIsImVuZHNXaXRoIiwicmVhZENTVkZpbGUiLCJmaWxlUmVhZGVyIiwiRmlsZVJlYWRlciIsIm9ubG9hZCIsInRhcmdldCIsInJlYWRBc1RleHQiLCJwcm9jZXNzb3IiLCJwcm9jZXNzQ3N2RGF0YSIsInJhd0RhdGEiLCJwcm9jZXNzR2VvanNvbiIsInJlYWRKU09ORmlsZSIsImNvbnRlbnQiLCJpc0tlcGxlckdsTWFwIiwiREFUQVNFVF9GT1JNQVRTIiwia2VwbGVyZ2wiLCJpc1Jvd09iamVjdCIsInJvdyIsImlzR2VvSnNvbiIsImdlb2pzb24iLCJDb25zb2xlIiwid2FybiIsIkpTT04iLCJwYXJzZSIsImVyciIsImlzRmVhdHVyZSIsImlzRmVhdHVyZUNvbGxlY3Rpb24iLCJnZW9tZXRyeSIsImZlYXR1cmVzIiwiQXJyYXkiLCJpc0FycmF5IiwiZGF0YXNldHMiLCJjb25maWciLCJhcHAiLCJkZXRlcm1pbmVKc29uUHJvY2VzcyIsImRlZmF1bHRQcm9jZXNzb3IiLCJkYXRhc2V0IiwicHJvY2Vzc0tlcGxlcmdsSlNPTiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQW9CQTs7QUFDQTs7QUFDQTs7QUFNQTs7QUFDQTs7QUE3QkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7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LENBQUMsQ0FBRCxDQUFsQixDQUE5QjtBQUNEOztBQUVNLFNBQVNrQyxhQUFULENBQXVCbEMsSUFBdkIsRUFBNkI7QUFDbEMsU0FDRSwwQkFBY0EsSUFBZCxLQUNBQSxJQUFJLENBQUNvRCxRQURMLElBRUFwRCxJQUFJLENBQUNxRCxNQUZMLElBR0FyRCxJQUFJLENBQUNjLElBSEwsSUFJQWQsSUFBSSxDQUFDYyxJQUFMLENBQVV3QyxHQUFWLEtBQWtCLFdBTHBCO0FBT0Q7O0FBRU0sU0FBU0Msb0JBQVQsUUFBaURDLGdCQUFqRCxFQUFtRTtBQUFBLE1BQXBDQyxPQUFvQyxTQUFwQ0EsT0FBb0M7QUFBQSxNQUEzQi9DLE1BQTJCLFNBQTNCQSxNQUEyQjs7QUFDeEUsTUFBSXdCLGFBQWEsQ0FBQ3VCLE9BQUQsQ0FBakIsRUFBNEI7QUFDMUIsV0FBT0Msa0NBQVA7QUFDRDs7QUFFRCxTQUFPRixnQkFBUDtBQUNEIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IChjKSAyMDIwIFViZXIgVGVjaG5vbG9naWVzLCBJbmMuXG4vL1xuLy8gUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEgY29weVxuLy8gb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgXCJTb2Z0d2FyZVwiKSwgdG8gZGVhbFxuLy8gaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0c1xuLy8gdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbFxuLy8gY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdCBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzXG4vLyBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOlxuLy9cbi8vIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkIGluXG4vLyBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS5cbi8vXG4vLyBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgXCJBUyBJU1wiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SXG4vLyBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSxcbi8vIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOIE5PIEVWRU5UIFNIQUxMIFRIRVxuLy8gQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUlxuLy8gTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSxcbi8vIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU5cbi8vIFRIRSBTT0ZUV0FSRS5cblxuaW1wb3J0IHtGaWxlUmVhZGVyfSBmcm9tICdnbG9iYWwvd2luZG93JztcclxuaW1wb3J0IENvbnNvbGUgZnJvbSAnZ2xvYmFsL2NvbnNvbGUnO1xyXG5pbXBvcnQge1xyXG4gIHByb2Nlc3NDc3ZEYXRhLFxyXG4gIHByb2Nlc3NHZW9qc29uLFxyXG4gIHByb2Nlc3NLZXBsZXJnbEpTT04sXHJcbiAgcHJvY2Vzc1Jvd09iamVjdFxyXG59IGZyb20gJy4vZGF0YS1wcm9jZXNzb3InO1xyXG5pbXBvcnQge2lzUGxhaW5PYmplY3R9IGZyb20gJ3V0aWxzL3V0aWxzJztcclxuaW1wb3J0IHtEQVRBU0VUX0ZPUk1BVFN9IGZyb20gJ2NvbnN0YW50cy9kZWZhdWx0LXNldHRpbmdzJztcclxuXHJcbmNvbnN0IEZJTEVfSEFORExFUlMgPSB7XHJcbiAgY3N2OiBsb2FkQ3N2LFxyXG4gIGpzb246IGxvYWRKU09OXHJcbn07XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gcmVhZEZpbGUoe2ZpbGUsIGZpbGVDYWNoZSA9IFtdfSkge1xyXG4gIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICBjb25zdCB7aGFuZGxlciwgZm9ybWF0fSA9IGdldEZpbGVIYW5kbGVyKGZpbGUpO1xyXG4vKiAgICBpZiAoIWhhbmRsZXIpIHtcclxuICAgICAgQ29uc29sZS53YXJuKFxyXG4gICAgICAgIGBDYW5vbnQgZGV0ZXJtaW5lIGZpbGUgaGFuZGxlciBmb3IgZmlsZSAke2ZpbGUubmFtZX0uIEl0IG11c3QgaGF2ZSBhIHZhbGlkIGZpbGUgZXh0ZW5zaW9uYFxyXG4gICAgICApO1xyXG4gICAgICByZXNvbHZlKGZpbGVDYWNoZSk7XHJcbiAgICB9XHJcbiovXHJcbiAgICBoYW5kbGVyKHtmaWxlLCBmb3JtYXR9KS50aGVuKHJlc3VsdCA9PiB7XHJcbiAgICAgIGlmICghcmVzdWx0IHx8ICFyZXN1bHQuZGF0YSkge1xyXG4gICAgICAgIC8vIHJldHVybiBmaWxlQ2FjaGUsIHRvIGtlZXAgcHJvY2VzcyBvdGhlciBmaWxlc1xyXG4gICAgICAgIHJlc29sdmUoZmlsZUNhY2hlKTtcclxuICAgICAgfVxyXG4gICAgICByZXNvbHZlKFtcclxuICAgICAgICAuLi5maWxlQ2FjaGUsXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgZGF0YTogcmVzdWx0LmRhdGEsXHJcbiAgICAgICAgICBpbmZvOiB7XHJcbiAgICAgICAgICAgIGxhYmVsOiBmaWxlLm5hbWUsXHJcbiAgICAgICAgICAgIGZvcm1hdDogcmVzdWx0LmZvcm1hdFxyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgXSk7XHJcbiAgICB9KTtcclxuICB9KTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGdldEZpbGVIYW5kbGVyKGZpbGVCbG9iKSB7XHJcbiAgY29uc3QgdHlwZSA9IGdldEZpbGVUeXBlKGZpbGVCbG9iLm5hbWUpO1xyXG5cclxuICByZXR1cm4ge2hhbmRsZXI6IEZJTEVfSEFORExFUlNbdHlwZV0sIGZvcm1hdDogdHlwZX07XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBnZXRGaWxlVHlwZShmaWxlbmFtZSkge1xyXG4gIGlmIChmaWxlbmFtZS5lbmRzV2l0aCgnY3N2JykpIHtcclxuICAgIHJldHVybiAnY3N2JztcclxuICB9IGVsc2UgaWYgKGZpbGVuYW1lLmVuZHNXaXRoKCdqc29uJykgfHwgZmlsZW5hbWUuZW5kc1dpdGgoJ2dlb2pzb24nKSkge1xyXG4gICAgLy8gUmVhZCBHZW9Kc29uIGZyb20gYnJvd3NlclxyXG4gICAgcmV0dXJuICdqc29uJztcclxuICB9IGVsc2Uge1xyXG4gICAgcmV0dXJuICdqc29uJztcclxuICB9XHJcblxyXG4gIC8vIFdhaXQgdG8gYWRkIG90aGVyIGZpbGUgdHlwZSBoYW5kbGVyXHJcbiAgcmV0dXJuICdvdGhlcic7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHJlYWRDU1ZGaWxlKGZpbGVCbG9iKSB7XHJcbiAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgIGNvbnN0IGZpbGVSZWFkZXIgPSBuZXcgRmlsZVJlYWRlcigpO1xyXG4gICAgZmlsZVJlYWRlci5vbmxvYWQgPSAoe3RhcmdldDoge3Jlc3VsdH19KSA9PiB7XHJcbiAgICAgIHJlc29sdmUocmVzdWx0KTtcclxuICAgIH07XHJcblxyXG4gICAgZmlsZVJlYWRlci5yZWFkQXNUZXh0KGZpbGVCbG9iKTtcclxuICB9KTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGxvYWRDc3Yoe2ZpbGUsIGZvcm1hdCwgcHJvY2Vzc29yID0gcHJvY2Vzc0NzdkRhdGF9KSB7XHJcbiAgcmV0dXJuIHJlYWRDU1ZGaWxlKGZpbGUpLnRoZW4ocmF3RGF0YSA9PiAocmF3RGF0YSA/IHtkYXRhOiBwcm9jZXNzb3IocmF3RGF0YSksIGZvcm1hdH0gOiBudWxsKSk7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBsb2FkSlNPTih7ZmlsZSwgcHJvY2Vzc29yID0gcHJvY2Vzc0dlb2pzb259KSB7XHJcbiAgcmV0dXJuIHJlYWRKU09ORmlsZShmaWxlKS50aGVuKGNvbnRlbnQgPT4ge1xyXG4gICAgaWYgKGlzS2VwbGVyR2xNYXAoY29udGVudCkpIHtcclxuICAgICAgcmV0dXJuIHtcclxuICAgICAgICBmb3JtYXQ6IERBVEFTRVRfRk9STUFUUy5rZXBsZXJnbCxcclxuICAgICAgICBkYXRhOiBwcm9jZXNzS2VwbGVyZ2xKU09OKGNvbnRlbnQpXHJcbiAgICAgIH07XHJcbiAgICB9IGVsc2UgaWYgKGlzUm93T2JqZWN0KGNvbnRlbnQpKSB7XHJcbiAgICAgIHJldHVybiB7XHJcbiAgICAgICAgZm9ybWF0OiBEQVRBU0VUX0ZPUk1BVFMucm93LFxyXG4gICAgICAgIGRhdGE6IHByb2Nlc3NSb3dPYmplY3QoY29udGVudClcclxuICAgICAgfTtcclxuICAgIH0gZWxzZSBpZiAoaXNHZW9Kc29uKGNvbnRlbnQpKSB7XHJcbiAgICAgIHJldHVybiB7XHJcbiAgICAgICAgZm9ybWF0OiBEQVRBU0VUX0ZPUk1BVFMuZ2VvanNvbixcclxuICAgICAgICBkYXRhOiBwcm9jZXNzR2VvanNvbihjb250ZW50KVxyXG4gICAgICB9O1xyXG4gICAgfVxyXG4gICAgLy8gdW5zdXBwb3J0ZWQganNvbiBmb3JtYXRcclxuICAgIENvbnNvbGUud2FybihgdW5zdXBwb3J0ZWQgSnNvbiBmb3JtYXQgJHtmaWxlLm5hbWV9YCk7XHJcbiAgICByZXR1cm4gbnVsbDtcclxuICB9KTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIHJlYWRKU09ORmlsZShmaWxlQmxvYikge1xyXG4gIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICBjb25zdCBmaWxlUmVhZGVyID0gbmV3IEZpbGVSZWFkZXIoKTtcclxuICAgIGZpbGVSZWFkZXIub25sb2FkID0gKHt0YXJnZXQ6IHtyZXN1bHR9fSkgPT4ge1xyXG4gICAgICB0cnkge1xyXG4gICAgICAgIGNvbnN0IGpzb24gPSBKU09OLnBhcnNlKHJlc3VsdCk7XHJcbiAgICAgICAgcmVzb2x2ZShqc29uKTtcclxuICAgICAgfSBjYXRjaCAoZXJyKSB7XHJcbiAgICAgICAgcmVqZWN0KG51bGwpO1xyXG4gICAgICB9XHJcbiAgICB9O1xyXG5cclxuICAgIGZpbGVSZWFkZXIucmVhZEFzVGV4dChmaWxlQmxvYiwgJ1VURi04Jyk7XHJcbiAgfSk7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBpc0dlb0pzb24oanNvbikge1xyXG4gIC8vIGpzb24gY2FuIGJlIGZlYXR1cmUgY29sbGVjdGlvblxyXG4gIC8vIG9yIHNpbWdsZSBmZWF0dXJlXHJcbiAgcmV0dXJuIGlzUGxhaW5PYmplY3QoanNvbikgJiYgKGlzRmVhdHVyZShqc29uKSB8fCBpc0ZlYXR1cmVDb2xsZWN0aW9uKGpzb24pKTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGlzRmVhdHVyZShqc29uKSB7XHJcbiAgcmV0dXJuIGpzb24udHlwZSA9PT0gJ0ZlYXR1cmUnICYmIGpzb24uZ2VvbWV0cnk7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBpc0ZlYXR1cmVDb2xsZWN0aW9uKGpzb24pIHtcclxuICByZXR1cm4ganNvbi50eXBlID09PSAnRmVhdHVyZUNvbGxlY3Rpb24nICYmIGpzb24uZmVhdHVyZXM7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBpc1Jvd09iamVjdChqc29uKSB7XHJcbiAgcmV0dXJuIEFycmF5LmlzQXJyYXkoanNvbikgJiYgaXNQbGFpbk9iamVjdChqc29uWzBdKTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGlzS2VwbGVyR2xNYXAoanNvbikge1xyXG4gIHJldHVybiAoXHJcbiAgICBpc1BsYWluT2JqZWN0KGpzb24pICYmXHJcbiAgICBqc29uLmRhdGFzZXRzICYmXHJcbiAgICBqc29uLmNvbmZpZyAmJlxyXG4gICAganNvbi5pbmZvICYmXHJcbiAgICBqc29uLmluZm8uYXBwID09PSAna2VwbGVyLmdsJ1xyXG4gICk7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBkZXRlcm1pbmVKc29uUHJvY2Vzcyh7ZGF0YXNldCwgZm9ybWF0fSwgZGVmYXVsdFByb2Nlc3Nvcikge1xyXG4gIGlmIChpc0tlcGxlckdsTWFwKGRhdGFzZXQpKSB7XHJcbiAgICByZXR1cm4gcHJvY2Vzc0tlcGxlcmdsSlNPTjtcclxuICB9XHJcblxyXG4gIHJldHVybiBkZWZhdWx0UHJvY2Vzc29yO1xyXG59XHJcbiJdfQ==